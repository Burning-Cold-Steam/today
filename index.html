<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Poster</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  display:grid;
  place-items:center;
  background:#0b0c10;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  color:#fff;
}

.poster{
  position:relative;
  width:min(92vw,420px);
  aspect-ratio:9/16;
  background:#000;
  border-radius:16px;
  overflow:hidden;
  touch-action:none;
}

.stage img{
  position:absolute;
  left:50%;
  top:50%;
  transform-origin:center;
  max-width:none;
  pointer-events:none;
}

.vignette{
  position:absolute;
  inset:0;
  pointer-events:none;
  background:radial-gradient(circle at center,rgba(0,0,0,0) 55%,rgba(0,0,0,.45) 100%);
}

.upload{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  background:rgba(0,0,0,.35);
  z-index:5;
}

.upload button{
  padding:12px 18px;
  border-radius:12px;
  border:none;
  background:#fff;
  color:#000;
  font-weight:600;
  cursor:pointer;
}

.controls{
  position:absolute;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  display:none;
  gap:8px;
  z-index:10;
}

.controls button{
  padding:8px 12px;
  border-radius:10px;
  border:none;
  background:rgba(0,0,0,.6);
  color:#fff;
  font-size:13px;
  cursor:pointer;
}

.affirmation{
  position:absolute;
  left:16px;
  right:16px;
  bottom:88px;
  text-align:center;
  padding:14px;
  border-radius:14px;
  background:rgba(0,0,0,.45);
  font-size:22px;
  font-weight:600;
  opacity:0;
  transition:opacity .6s ease;
}

.showText .affirmation{opacity:1}

.preview{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:100;
  gap:14px;
}

.preview img{
  max-width:90%;
  border-radius:12px;
}

.preview button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#fff;
  color:#000;
  font-weight:600;
}
</style>
</head>

<body>

<div class="poster" id="poster">
  <div class="stage">
    <img id="photo">
  </div>

  <div class="vignette"></div>

  <div class="affirmation" id="affirmation"></div>

  <div class="controls" id="controls">
    <button id="fitBtn">Fit</button>
    <button id="retryBtn">Retry</button>
    <button id="saveBtn">Save</button>
  </div>

  <div class="upload" id="upload">
    <button id="chooseBtn">Choose image</button>
    <input id="fileInput" type="file" accept="image/*" hidden>
  </div>
</div>

<div class="preview" id="preview">
  <img id="previewImg">
  <button id="closePreview">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const poster=document.getElementById('poster');
const photo=document.getElementById('photo');
const upload=document.getElementById('upload');
const fileInput=document.getElementById('fileInput');
const chooseBtn=document.getElementById('chooseBtn');
const controls=document.getElementById('controls');
const affirmationEl=document.getElementById('affirmation');
const fitBtn=document.getElementById('fitBtn');
const retryBtn=document.getElementById('retryBtn');
const saveBtn=document.getElementById('saveBtn');
const preview=document.getElementById('preview');
const previewImg=document.getElementById('previewImg');
const closePreview=document.getElementById('closePreview');

let scale=1,x=0,y=0;
let pointers=new Map(),lastDist=null;

const AFFIRMATIONS={
  morning:["This person is allowed a gentle start.","You donâ€™t need to rush today."],
  afternoon:["This person is doing better than they think.","Your effort matters."],
  evening:["This person did enough for today.","Rest is allowed."],
  night:["This person is safe to rest.","You are enough."]
};

function pickAffirmation(){
  const h=new Date().getHours();
  const k=h<12?"morning":h<17?"afternoon":h<22?"evening":"night";
  const a=AFFIRMATIONS[k];
  affirmationEl.textContent=a[Math.floor(Math.random()*a.length)];
}

function apply(){
  photo.style.transform=`translate(-50%,-50%) translate(${x}px,${y}px) scale(${scale})`;
}

function fit(){
  x=0;y=0;
  scale=Math.min(
    poster.clientWidth/photo.naturalWidth,
    poster.clientHeight/photo.naturalHeight
  );
  apply();
}

chooseBtn.onclick=()=>fileInput.click();

fileInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  photo.onload=()=>{
    upload.style.display="none";
    controls.style.display="flex";
    fit();
    pickAffirmation();
    setTimeout(()=>poster.classList.add("showText"),6000);
  };
  photo.src=URL.createObjectURL(f);
};

retryBtn.onclick=pickAffirmation;
fitBtn.onclick=fit;

poster.addEventListener("pointerdown",e=>{
  pointers.set(e.pointerId,e);
  if(pointers.size===2){
    const [a,b]=[...pointers.values()];
    lastDist=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
  }
});

poster.addEventListener("pointermove",e=>{
  if(!pointers.has(e.pointerId))return;
  const prev=pointers.get(e.pointerId);
  pointers.set(e.pointerId,e);

  if(pointers.size===1){
    x+=e.clientX-prev.clientX;
    y+=e.clientY-prev.clientY;
    apply();
  }
  if(pointers.size===2){
    const [a,b]=[...pointers.values()];
    const d=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
    scale*=d/lastDist;
    lastDist=d;
    apply();
  }
});

poster.addEventListener("pointerup",e=>{
  pointers.delete(e.pointerId);
  if(pointers.size<2)lastDist=null;
});

saveBtn.onclick=async()=>{
  const canvas=await html2canvas(poster,{scale:2});
  previewImg.src=canvas.toDataURL("image/png");
  preview.style.display="flex";
};

closePreview.onclick=()=>preview.style.display="none";
</script>

</body>
</html>
